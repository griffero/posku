<div class="mb-8">
  <h1 class="text-2xl font-bold text-gray-900">Ocupación del Viaje</h1>
  <p class="mt-2 text-sm text-gray-700">
    <%= @trip.route.origin_terminal.city %> → <%= @trip.route.destination_terminal.city %> -
    <%= @trip.departure_at.strftime("%d/%m/%Y %H:%M") %>
  </p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Stats -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Resumen</h3>
    <dl class="space-y-4">
      <div class="flex justify-between">
        <dt class="text-sm text-gray-500">Total asientos</dt>
        <dd class="text-sm font-medium text-gray-900"><%= @trip.bus.total_seats %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-sm text-gray-500">Ocupados</dt>
        <dd class="text-sm font-medium text-red-600"><%= @occupied_seats.count %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-sm text-gray-500">Disponibles</dt>
        <dd class="text-sm font-medium text-green-600"><%= @trip.available_seats_count %></dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-sm text-gray-500">Ocupación</dt>
        <dd class="text-sm font-medium text-gray-900"><%= ((@occupied_seats.count.to_f / @trip.bus.total_seats) * 100).round(1) %>%</dd>
      </div>
    </dl>
  </div>

  <!-- Seat Map -->
  <div class="lg:col-span-2 bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Mapa de Asientos</h3>
    <div class="flex gap-4 mb-4">
      <div class="flex items-center">
        <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
        <span class="text-sm text-gray-600">Disponible</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
        <span class="text-sm text-gray-600">Ocupado</span>
      </div>
    </div>

    <% @trip.bus.seat_layout["floors"]&.each do |floor_data| %>
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Piso <%= floor_data["floor"] %></h4>
        <div class="space-y-1">
          <% floor_data["rows"]&.each do |row_data| %>
            <div class="flex gap-1">
              <% row_data["seats"]&.each do |seat_data| %>
                <% if seat_data.nil? %>
                  <div class="w-8 h-8"></div>
                <% else %>
                  <% seat_number = "#{floor_data['floor']}-#{row_data['row']}#{seat_data['col']}" %>
                  <% occupied = @occupied_seats.include?(seat_number) %>
                  <div class="w-8 h-8 rounded flex items-center justify-center text-xs font-medium <%= occupied ? 'bg-red-500 text-white' : 'bg-green-500 text-white' %>" title="<%= seat_number %>">
                    <%= seat_data['col'] %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Reservations List -->
<div class="mt-6 bg-white shadow rounded-lg overflow-hidden">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <h3 class="text-lg leading-6 font-medium text-gray-900">Reservas</h3>
  </div>
  <table class="min-w-full divide-y divide-gray-300">
    <thead class="bg-gray-50">
      <tr>
        <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">Código</th>
        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Pasajeros</th>
        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Asientos</th>
        <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Estado</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200 bg-white">
      <% @reservations.each do |reservation| %>
        <tr>
          <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-indigo-600">
            <%= link_to reservation.locator_code, admin_reservation_path(reservation) %>
          </td>
          <td class="px-3 py-4 text-sm text-gray-500">
            <%= reservation.passengers.map(&:full_name).join(", ") %>
          </td>
          <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <%= reservation.reservation_seats.pluck(:seat_number).join(", ") %>
          </td>
          <td class="whitespace-nowrap px-3 py-4 text-sm">
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium 
              <%= reservation.status == 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
              <%= reservation.status_label %>
            </span>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
